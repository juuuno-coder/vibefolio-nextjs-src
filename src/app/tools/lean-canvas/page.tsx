"use client";

import React, { useState, useRef } from "react";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Loader2, Wand2, Rocket, Share2, Download, ArrowRight } from "lucide-react";
import { toast, Toaster } from "sonner";
import html2canvas from "html2canvas";

// --- Types & Data ---

interface LeanCanvasData {
  problem: string;
  customerSegments: string;
  uniqueValueProposition: string;
  solution: string;
  channels: string;
  revenueStreams: string;
  costStructure: string;
  keyMetrics: string;
  unfairAdvantage: string;
}

const initialData: LeanCanvasData = {
  problem: "",
  customerSegments: "",
  uniqueValueProposition: "",
  solution: "",
  channels: "",
  revenueStreams: "",
  costStructure: "",
  keyMetrics: "",
  unfairAdvantage: "",
};

// --- Page Component ---

export default function LeanCanvasPage() {
  const router = useRouter();
  const [topic, setTopic] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [isGenerated, setIsGenerated] = useState(false);
  const [canvasData, setCanvasData] = useState<LeanCanvasData>(initialData);
  const canvasRef = useRef<HTMLDivElement>(null);

  const handleGenerate = async () => {
    if (!topic.trim()) {
      toast.error("ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    setIsLoading(true);
    // TODO: AI API Integration
    setTimeout(() => {
      setCanvasData({
        problem: `1. ì‹œì¥ì˜ ê¸°ì¡´ ì†”ë£¨ì…˜ì´ ë„ˆë¬´ ë³µì¡í•¨\n2. ë†’ì€ ê°€ê²©ëŒ€ë¡œ ì¸í•œ ì ‘ê·¼ì„± ì €í•˜\n3. ${topic} ê´€ë ¨ ì „ë¬¸ ì§€ì‹ ë¶€ì¡±`,
        customerSegments: `1. ${topic}ì— ê´€ì‹¬ ìˆëŠ” 2030 ì„¸ëŒ€\n2. íš¨ìœ¨ì„±ì„ ì¶”êµ¬í•˜ëŠ” ì‹¤ë¬´ì\n3. ìƒˆë¡œìš´ ë„êµ¬ë¥¼ ì°¾ëŠ” ì–¼ë¦¬ì–´ë‹µí„°`,
        uniqueValueProposition: `"${topic}"ì„(ë¥¼) ìœ„í•œ\nê°€ì¥ ì‰½ê³  ì§ê´€ì ì¸ ì†”ë£¨ì…˜.\në³µì¡í•¨ì€ ì¤„ì´ê³ , í•µì‹¬ ê°€ì¹˜ì— ì§‘ì¤‘.`,
        solution: `1. AI ê¸°ë°˜ ìë™í™” ì‹œìŠ¤í…œ\n2. ì›í´ë¦­ ì›Œí¬í”Œë¡œìš°\n3. ì‚¬ìš©ì ì¹œí™”ì ì¸ UX/UI`,
        channels: `1. Instagram & TikTok ìˆí¼ ë§ˆì¼€íŒ…\n2. ê´€ë ¨ ë„¤ì´ë²„ ì¹´í˜ ë° ì»¤ë®¤ë‹ˆí‹°\n3. ì¸í”Œë£¨ì–¸ì„œ ì œíœ´`,
        revenueStreams: `1. ë¶€ë¶„ ìœ ë£Œí™” (Freemium)\n2. í”„ë¦¬ë¯¸ì—„ êµ¬ë… ë©¤ë²„ì‹­\n3. ê¸°ì—…ìš© ë¼ì´ì„ ìŠ¤ íŒë§¤`,
        costStructure: `1. í´ë¼ìš°ë“œ ì„œë²„ ìš´ì˜ë¹„\n2. ë§ˆì¼€íŒ… ë° ê´‘ê³  ì§‘í–‰ë¹„\n3. ì´ˆê¸° ê°œë°œ ì¸ê±´ë¹„`,
        keyMetrics: `1. ì›”ê°„ í™œì„± ì‚¬ìš©ì (MAU)\n2. ê³ ê° íšë“ ë¹„ìš© (CAC)\n3. ìœ ë£Œ ì „í™˜ìœ¨ (Conversion Rate)`,
        unfairAdvantage: `1. ìì²´ ê°œë°œ ë°ì´í„°ì…‹\n2. ì••ë„ì ì¸ ì‚¬ìš©ì ê²½í—˜\n3. ê°•ë ¥í•œ ì´ˆê¸° íŒ¬ë¤`,
      });
      setIsLoading(false);
      setIsGenerated(true);
      toast.success("ë¦° ìº”ë²„ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }, 2000);
  };

  const handleChange = (key: keyof LeanCanvasData, value: string) => {
    setCanvasData((prev) => ({ ...prev, [key]: value }));
  };

  const handleDownloadImage = async () => {
    if (!canvasRef.current) return;
    try {
      const canvas = await html2canvas(canvasRef.current, { scale: 2 });
      const link = document.createElement("a");
      link.download = `${topic || "leancanvas"}-vibefolio.png`;
      link.href = canvas.toDataURL();
      link.click();
      toast.success("ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) {
      console.error(e);
      toast.error("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  };

  const handleStartProject = () => {
    // Format to Markdown
    const content = `
## ğŸš€ ${topic ? topic + ' - ' : ''}ë¦° ìº”ë²„ìŠ¤ ê¸°íšì•ˆ

> **Generated by Vibefolio AI Planner**

### 1. ë¬¸ì œ (Problem)
${canvasData.problem}

### 2. ê³ ê°êµ° (Customer Segments)
${canvasData.customerSegments}

### 3. ê³ ìœ  ê°€ì¹˜ ì œì•ˆ (Unique Value Proposition)
${canvasData.uniqueValueProposition}

### 4. ì†”ë£¨ì…˜ (Solution)
${canvasData.solution}

### 5. ê²½ìŸ ìš°ìœ„ (Unfair Advantage)
${canvasData.unfairAdvantage}

### 6. ì±„ë„ (Channels)
${canvasData.channels}

### 7. í•µì‹¬ ì§€í‘œ (Key Metrics)
${canvasData.keyMetrics}

### 8. ë¹„ìš© êµ¬ì¡° (Cost Structure)
${canvasData.costStructure}

### 9. ìˆ˜ìµì› (Revenue Streams)
${canvasData.revenueStreams}
    `.trim();

    // Save to LocalStorage for import
    localStorage.setItem('project_import_content', content);
    localStorage.setItem('project_import_title', topic);
    localStorage.setItem('project_import_type', 'lean_canvas');
    
    // Redirect
    toast.success("í”„ë¡œì íŠ¸ ì—ë””í„°ë¡œ ì´ë™í•©ë‹ˆë‹¤...");
    setTimeout(() => {
        router.push('/project/upload');
    }, 1000);
  };

  return (
    <div className="min-h-screen bg-white">
      <Toaster position="top-center" richColors />
      
      {/* Hero Section */}
      <div className="bg-[#111] text-white py-20 px-4 relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-full opacity-20 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>
        <div className="absolute -top-20 -right-20 w-96 h-96 bg-purple-600 rounded-full blur-[100px] opacity-40"></div>
        <div className="absolute -bottom-20 -left-20 w-96 h-96 bg-green-500 rounded-full blur-[100px] opacity-30"></div>

        <div className="max-w-4xl mx-auto text-center relative z-10 animate-in fade-in slide-in-from-bottom-6 duration-700">
          <div className="inline-block px-3 py-1 bg-white/10 rounded-full text-xs font-bold text-green-400 mb-6 border border-white/10 backdrop-blur-sm">
            âœ¨ LABS : AI ê¸°íš ë„ìš°ë¯¸
          </div>
          <h1 className="text-4xl md:text-6xl font-black mb-6 leading-tight tracking-tight">
            ë§‰ì—°í•œ ì•„ì´ë””ì–´, <br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-400">10ì´ˆ ë§Œì— ê¸°íšì„œ</span>ë¡œ ë§Œë“œì„¸ìš”.
          </h1>
          <p className="text-lg text-gray-400 mb-10 max-w-2xl mx-auto leading-relaxed">
            ìŠ¤íƒ€íŠ¸ì—…ì˜ í•„ìˆ˜í’ˆ 'ë¦° ìº”ë²„ìŠ¤(Lean Canvas)'ë¥¼ AIê°€ ëŒ€ì‹  ì‘ì„±í•´ë“œë¦½ë‹ˆë‹¤.<br className="hidden md:block"/>
            ì‘ì„±ëœ ê¸°íšì•ˆìœ¼ë¡œ ë°”ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.
          </p>

          <div className="max-w-xl mx-auto relative group">
            <div className="absolute inset-0 bg-gradient-to-r from-green-500 to-purple-600 rounded-2xl blur opacity-30 group-hover:opacity-50 transition-opacity"></div>
            <div className="relative bg-white rounded-2xl p-2 flex items-center shadow-2xl">
              <Input
                value={topic}
                onChange={(e) => setTopic(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleGenerate()}
                placeholder="ì˜ˆ: 20ëŒ€ ëŒ€í•™ìƒì„ ìœ„í•œ AI ìì†Œì„¤ ì²¨ì‚­ ì„œë¹„ìŠ¤"
                className="border-0 h-14 text-lg text-black placeholder:text-gray-400 focus-visible:ring-0 bg-transparent px-4"
              />
              <Button 
                onClick={handleGenerate} 
                disabled={isLoading}
                className="h-12 px-8 bg-black hover:bg-gray-800 text-white rounded-xl font-bold text-lg gap-2 transition-all"
              >
                {isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Wand2 className="w-5 h-5" />}
                {isLoading ? "ìƒì„± ì¤‘..." : "AI ìƒì„±"}
              </Button>
            </div>
          </div>
          <p className="text-xs text-gray-500 mt-4">ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œë„ ë¬´ë£Œë¡œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>

      {/* Canvas Section */}
      <div className="container mx-auto px-4 py-16">
        <div className={`transition-all duration-1000 ${isGenerated ? 'opacity-100 translate-y-0' : 'opacity-40 translate-y-10 brightness-95 grayscale'}`}>
            
            {/* Toolbar */}
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold flex items-center gap-2">
                    ğŸ“Š ë¦° ìº”ë²„ìŠ¤ ê²°ê³¼
                    {!isGenerated && <span className="text-sm font-normal text-gray-400 ml-2">(ìƒì„± ëŒ€ê¸° ì¤‘...)</span>}
                </h2>
                <div className="flex gap-3">
                    <Button variant="outline" onClick={handleDownloadImage} disabled={!isGenerated} className="gap-2">
                        <Download className="w-4 h-4" /> ì´ë¯¸ì§€ ì €ì¥
                    </Button>
                    <Button onClick={handleStartProject} disabled={!isGenerated} className="bg-green-600 hover:bg-green-700 text-white gap-2 font-bold shadow-lg hover:translate-y-[-2px] transition-all">
                        <Rocket className="w-4 h-4" /> ì´ ê¸°íšìœ¼ë¡œ í”„ë¡œì íŠ¸ ì‹œì‘í•˜ê¸°
                    </Button>
                </div>
            </div>

            {/* Grid */}
            <div ref={canvasRef} className="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                {/* Canvas Header (For Screenshot) */}
                <div className="mb-8 border-b border-gray-100 pb-4 flex justify-between items-end">
                    <div>
                        <h3 className="text-3xl font-black text-gray-900">{topic || "ë‚˜ì˜ ì•„ì´ë””ì–´"}</h3>
                        <p className="text-sm text-gray-500 mt-1">Generated by Vibefolio AI</p>
                    </div>
                    <div className="text-right">
                        <div className="text-xs text-gray-400">Date</div>
                        <div className="font-medium">{new Date().toLocaleDateString()}</div>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-5 md:grid-rows-3 gap-4 min-h-[800px]">
                    {/* 1. Problem */}
                    <CanvasBlock
                    title="1. ë¬¸ì œ (Problem)"
                    subtitle="ê³ ê°ì´ ê²ªëŠ” ìƒìœ„ 3ê°€ì§€ ë¬¸ì œ"
                    value={canvasData.problem}
                    onChange={(v) => handleChange("problem", v)}
                    className="md:row-span-2 md:col-span-1"
                    icon="ğŸ”¥"
                    />
                    
                    {/* 4. Solution */}
                    <CanvasBlock
                    title="4. ì†”ë£¨ì…˜ (Solution)"
                    subtitle="ê° ë¬¸ì œì— ëŒ€í•œ í•´ê²°ì±…"
                    value={canvasData.solution}
                    onChange={(v) => handleChange("solution", v)}
                    className="md:col-span-1"
                    icon="ğŸ’¡"
                    />

                    {/* 3. UVP */}
                    <CanvasBlock
                    title="3. ê°€ì¹˜ ì œì•ˆ (UVP)"
                    subtitle="ì°¨ë³„í™”ëœ í•µì‹¬ ê°€ì¹˜ ë©”ì‹œì§€"
                    value={canvasData.uniqueValueProposition}
                    onChange={(v) => handleChange("uniqueValueProposition", v)}
                    className="md:row-span-2 md:col-span-1 bg-purple-50/50 border-purple-100"
                    icon="ğŸ’"
                    isHighlight
                    />

                    {/* 9. Unfair Advantage */}
                    <CanvasBlock
                    title="9. ê²½ìŸ ìš°ìœ„ (Advantage)"
                    subtitle="ì‰½ê²Œ ë³µì œí•  ìˆ˜ ì—†ëŠ” ê°•ì "
                    value={canvasData.unfairAdvantage}
                    onChange={(v) => handleChange("unfairAdvantage", v)}
                    className="md:col-span-1"
                    icon="ğŸ›¡ï¸"
                    />

                    {/* 2. Customer Segments */}
                    <CanvasBlock
                    title="2. ê³ ê°êµ° (Segments)"
                    subtitle="ëª©í‘œ ê³ ê° ë° ì–¼ë¦¬ì–´ë‹µí„°"
                    value={canvasData.customerSegments}
                    onChange={(v) => handleChange("customerSegments", v)}
                    className="md:row-span-2 md:col-span-1"
                    icon="ğŸ¯"
                    />

                    {/* 8. Key Metrics */}
                    <CanvasBlock
                    title="8. í•µì‹¬ ì§€í‘œ (Metrics)"
                    subtitle="ì„±ê³µì„ ì¸¡ì •í•˜ëŠ” í•µì‹¬ ìˆ«ì"
                    value={canvasData.keyMetrics}
                    onChange={(v) => handleChange("keyMetrics", v)}
                    className="md:col-span-1"
                    icon="ğŸ“Š"
                    />

                    {/* 5. Channels */}
                    <CanvasBlock
                    title="5. ì±„ë„ (Channels)"
                    subtitle="ê³ ê°ì—ê²Œ ë„ë‹¬í•˜ëŠ” ê²½ë¡œ"
                    value={canvasData.channels}
                    onChange={(v) => handleChange("channels", v)}
                    className="md:col-span-1"
                    icon="ğŸ“¢"
                    />

                    {/* 7. Cost Structure */}
                    <CanvasBlock
                    title="7. ë¹„ìš© êµ¬ì¡° (Cost Structure)"
                    subtitle="ê³ ì •ë¹„, ë³€ë™ë¹„ ë“± ì£¼ìš” ë¹„ìš©"
                    value={canvasData.costStructure}
                    onChange={(v) => handleChange("costStructure", v)}
                    className="md:col-span-2.5 md:row-span-1"
                    icon="ğŸ’¸"
                    />

                    {/* 6. Revenue Streams */}
                    <CanvasBlock
                    title="6. ìˆ˜ìµì› (Revenue Streams)"
                    subtitle="ìˆ˜ìµ ëª¨ë¸, ê°€ê²© ì •ì±…"
                    value={canvasData.revenueStreams}
                    onChange={(v) => handleChange("revenueStreams", v)}
                    className="md:col-span-2.5 md:row-span-1 bg-green-50/50 border-green-100"
                    icon="ğŸ’°"
                    />
                </div>
            </div>
        </div>
      </div>

      {/* Footer CTA */}
      <div className="bg-gray-50 border-t border-gray-200 py-16 text-center">
        <h2 className="text-3xl font-bold mb-4">ì¤€ë¹„ëœ ê¸°íš, í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ì™„ì„±í•˜ì„¸ìš”</h2>
        <p className="text-gray-500 mb-8">ë°”ì´ë¸Œí´ë¦¬ì˜¤ëŠ” ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ê°€ ì„¸ìƒê³¼ ë§Œë‚˜ëŠ” ê³³ì…ë‹ˆë‹¤.</p>
        <Button onClick={() => router.push('/')} variant="outline" className="h-12 px-8 rounded-full border-gray-300 hover:bg-white text-lg">
            ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </Button>
      </div>
    </div>
  );
}

function CanvasBlock({ 
    title, 
    subtitle, 
    value, 
    onChange, 
    className, 
    icon,
    isHighlight = false
}: { 
    title: string; 
    subtitle: string; 
    value: string; 
    onChange: (v: string) => void; 
    className?: string;
    icon: string;
    isHighlight?: boolean;
}) {
    return (
        <div className={`flex flex-col border rounded-xl p-4 transition-all duration-300 hover:shadow-md ${isHighlight ? 'border-purple-200 ring-4 ring-purple-50/50' : 'border-gray-200 hover:border-gray-400 bg-white'} ${className}`}>
            <div className="flex items-center justify-between mb-2">
                <h3 className="font-bold text-base text-gray-800 flex items-center gap-2">
                    <span className="text-lg">{icon}</span> {title}
                </h3>
            </div>
            <p className="text-xs text-gray-400 mb-3">{subtitle}</p>
            <Textarea
                value={value}
                onChange={(e) => onChange(e.target.value)}
                className="flex-1 w-full resize-none text-sm leading-relaxed border-0 bg-transparent p-0 focus-visible:ring-0 placeholder:text-gray-300 min-h-[100px]"
                placeholder="ë‚´ìš©ì´ ìƒì„±ë©ë‹ˆë‹¤..."
            />
        </div>
    );
}
