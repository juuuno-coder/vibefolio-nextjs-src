-- =================================================================
-- VIBEFOLIO Evaluation System Setup Script
-- =================================================================
-- Description: Sets up the ProjectRating table and related policies 
-- for the evaluation system.
-- =================================================================

-- 1. Create ProjectRating Table
-- -------------------------------------------------------------
CREATE TABLE IF NOT EXISTS "ProjectRating" (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    project_id BIGINT NOT NULL REFERENCES "Project"(project_id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- Nullable for Guest/Anonymous
    guest_id TEXT, -- For tracking guest sessions if needed
    
    -- Scores (1-5)
    score NUMERIC DEFAULT 0, -- Average/Total Score
    score_1 NUMERIC DEFAULT 0, -- 기획력 (Planning)
    score_2 NUMERIC DEFAULT 0, -- 완성도 (Completeness)
    score_3 NUMERIC DEFAULT 0, -- 독창성 (Originality)
    score_4 NUMERIC DEFAULT 0, -- 상업성 (Marketability)
    score_5 NUMERIC DEFAULT 0, -- 확장성 (Scalability) (Optional)
    score_6 NUMERIC DEFAULT 0, -- 기타 (Other) (Optional)
    
    -- Feedback
    comment TEXT, -- Overall comment
    proposal TEXT, -- Detailed proposal or feedback
    custom_answers JSONB, -- For additional Q&A responses
    
    -- Metadata
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 2. Enable RLS
-- -------------------------------------------------------------
ALTER TABLE "ProjectRating" ENABLE ROW LEVEL SECURITY;

-- 3. Policies
-- -------------------------------------------------------------
-- Allow everyone to read ratings (for displaying averages)
CREATE POLICY "Public ratings are viewable by everyone" 
ON "ProjectRating" FOR SELECT 
USING (true);

-- Allow authenticated users to insert their own ratings
CREATE POLICY "Users can insert their own ratings" 
ON "ProjectRating" FOR INSERT 
WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

-- Allow users to update their own ratings
CREATE POLICY "Users can update their own ratings" 
ON "ProjectRating" FOR UPDATE 
USING (auth.uid() = user_id OR user_id IS NULL);

-- 4. Indexes for Performance
-- -------------------------------------------------------------
CREATE INDEX IF NOT EXISTS idx_projectrating_project_id ON "ProjectRating"(project_id);
CREATE INDEX IF NOT EXISTS idx_projectrating_user_id ON "ProjectRating"(user_id);
CREATE INDEX IF NOT EXISTS idx_projectrating_created_at ON "ProjectRating"(created_at);

-- 5. Helper Tables (Optional - if consistent tags/stickers needed)
-- -------------------------------------------------------------
-- Table for Sticker Polls if separate
CREATE TABLE IF NOT EXISTS "FeedbackPoll" (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id BIGINT NOT NULL REFERENCES "Project"(project_id) ON DELETE CASCADE,
    sticker_id TEXT NOT NULL,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_feedbackpoll_project_stripe ON "FeedbackPoll"(project_id, sticker_id);
