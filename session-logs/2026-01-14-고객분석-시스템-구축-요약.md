# 세션 회고: 고객 분석(Analytics) 시스템 구축 및 고도화

### 데이터로 읽는 사용자의 마음: 방문자 트래킹부터 시각화까지

**작성일:** 2026년 01월 14일 (최근 작업 내역 정리)
**작성자:** Antigravity (AI Assistant)

---

## 1. 프로젝트 개요 (Overview)

Vibefolio의 성장을 정량적으로 측정하고, 마케팅 전략을 수립하기 위해 **자체적인 고객 분석(Analytics) 시스템**을 구축했다. 외부 툴(GA4 등)에만 의존하지 않고, 서비스 내부 DB에 직접 접속 로그를 쌓아 관리자 대시보드에서 실시간으로 현황을 파악하는 것이 목표였다.

## 2. 주요 구현 내용 (Implementation)

### 2.1. 데이터베이스 설계 (Schema Design)

방문자의 발자취를 남기기 위해 `Supabase`에 두 가지 핵심 테이블과 함수를 설계했다.

1.  **`visit_logs` 테이블:** 개별 방문에 대한 상세 기록.
    - `ip_address`: 중복 카운팅 방지 (해싱 고려).
    - `referrer`: 유입 경로 (어디서 왔는가?).
    - `user_agent`: 디바이스 및 브라우저 정보.
    - `path`: 방문한 페이지 경로.
2.  **`daily_visits` 테이블:** 일별 방문자 수 통계 집계.
    - `date`: 날짜 (YYYY-MM-DD).
    - `count`: 해당 일의 총 방문 횟수.
3.  **`increment_daily_visits` (RPC 함수):** 트랜잭션 안전성을 위해 DB 레벨에서 카운트를 1씩 증가시키는 프로시저 함수.

### 2.2. 방문 감지 및 로깅 로직 (Tracking Logic)

- **미들웨어/레이아웃 통합:** 사용자가 사이트에 접속하는 순간(`src/app/layout.tsx` 또는 `middleware.ts`)을 포착하여 로그를 전송한다.
- **중복 방지:** 세션 스토리지(`sessionStorage`)를 활용하여 한 세션 내에서의 무분별한 중복 카운팅을 방지했다. (새로고침 시 카운트 증가 안 함)
- **데이터 정제:** `User-Agent` 문자열을 파싱하여 **Desktop / Mobile**을 구분하고, `Referrer` URL에서 도메인만 추출하여 저장했다.

### 2.3. 관리자 대시보드 시각화 (Dashboard Visualization)

수집된 데이터를 관리자가 한눈에 볼 수 있도록 `Recharts` 라이브러리를 활용해 시각화했다. (`src/app/admin/analytics/page.tsx`)

- **방문자 추이 차트 (Line Chart):** 최근 7일/30일간의 방문자 수 변화를 그래프로 표시.
- **디바이스 비율 (Donut Chart):** PC와 모바일 접속 비율을 파이 차트로 표현하여 반응형 대응 전략의 근거 마련.
- **유입 경로 순위 (List):** "구글 검색", "인스타그램", "직접 접속" 등 주요 유입 채널 TOP 5를 리스트업.

### 2.4. SEO 및 외부 트래킹 연동

자체 분석뿐만 아니라 검증된 외부 툴과의 연동도 완료했다.

- **Google Analytics (GA4):** `gtag.js` 스크립트 삽입.
- **Naver Search Advisor:** 네이버 검색 노출을 위한 소유권 확인 태그 삽입.
- **Open Graph (OG) 태그:** 카카오톡, 페이스북 공유 시 미리보기가 예쁘게 나오도록 메타 태그 최적화.

## 3. 트러블슈팅 (Troubleshooting)

### 3.1. 타임존(Timezone)의 늪

**문제:** 관리자 대시보드에서 "오늘"의 방문자 수가 자꾸 0으로 초기화되거나 날짜가 밀리는 현상 발생. 서버(UTC)와 한국(KST, UTC+9)의 시차 때문.
**해결:**

- DB 쿼리 시 `T00:00:00+09:00` 오프셋을 명시적으로 붙여 한국 시간 기준 자정을 정확히 계산.
- 프론트엔드 날짜 표시 시 `date-fns` 또는 `dayjs` 등을 활용해 로컬 시간대로 강제 변환하여 표시.

### 3.2. 카운트 누락 및 과다 집계

**문제:** 뒤로 가기나 단순 새로고침 시에도 카운트가 올라가 데이터가 뻥튀기됨.
**해결:** `React.StrictMode` 로 인한 이중 호출 방지 및 세션 스토리지 플래그(`visited_today`)를 체크하여 "유효 방문"만 카운팅하도록 로직 개선.

---

## 4. 향후 발전 과제 (Next Steps)

- **페이지별 체류 시간(Duration) 측정:** 사용자가 어떤 콘텐츠를 가장 흥미롭게 보는지 분석.
- **이탈률(Bounce Rate) 분석:** 단일 페이지만 보고 나가는 비율 측정.
- **사용자 행동 흐름(User Flow):** 메인 -> 상세 -> 결제(문의)로 이어지는 퍼널 분석.
